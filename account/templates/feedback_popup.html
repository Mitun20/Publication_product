<!-- Font Awesome (for icons) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  .offcanvas-end {
    width: 500px;
  }

  .feedback-list {
    max-height: 500px;
    overflow-y: auto;
    padding-top: 10px;
    padding-right: 10px;
    padding-left: 10px;
    background: #f9f9f9;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
  }

  .card-feedback {
    border-left: 4px solid #007bff;
    border-radius: 0.5rem;
    background: #ffffff;
  }

  .card-feedback:hover {
    background: #f5f9ff;
  }

  .feedback-icon {
    font-size: 1.2rem;
    color: #007bff;
    margin-right: 0.5rem;
  }
</style>

<!-- Feedback Sidebar (Offcanvas) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="feedbackSidebar" aria-labelledby="feedbackSidebarLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="feedbackSidebarLabel"><i class="fas fa-comments feedback-icon"></i> Feedback</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column">

    <!-- Existing Feedbacks -->
    <h6 class="fw-bold">All Feedbacks:</h6>
    <div class="feedback-list mb-4 flex-grow-1">
      {% if feedbacks %}
        {% for feedback in feedbacks %}
          <div class="card mb-3 shadow-sm border-0 card-feedback">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <h6 class="mb-0 text-primary">
                  <i class="fas fa-user-circle mr-2"></i>{{ feedback.user.username }}
                </h6>
                <small class="text-muted">{{ feedback.submitted_on|date:"M d, Y H:i" }}</small>
              </div>
              <p class="mb-0">{{ feedback.feedback }}</p>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No feedback yet.</p>
      {% endif %}
    </div>

    <!-- New Feedback Form -->
    <div class="border-top pt-3 mt-auto">
      <h6 class="fw-bold">New Feedback:</h6>
      <form id="feedbackForm" method="post" action="{% url 'submit_feedback' %}">
        {% csrf_token %}
        <div class="form-group mb-2">
          <textarea class="form-control" name="feedback" rows="3"
                    placeholder="Enter your feedback here..." required
                    style="border-radius: 0.5rem;"></textarea>
        </div>
        
        <button type="submit" class="btn btn-primary w-100">Submit</button>
      </form>
    </div>
  </div>
</div>

<!-- Feedback JavaScript -->
<script>
function loadFeedbacks() {
    $.ajax({
        url: '{% url "feedback_list" %}',
        type: 'GET',
        success: function(data) {
            $('#feedbackSidebar .offcanvas-body').html(
                $(data).find('.offcanvas-body').html()
            );
        },
        error: function() {
            alert('Error loading feedbacks');
        }
    });
}

$(document).ready(function() {
    $(document).on('submit', '#feedbackForm', function(e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
            type: 'POST',
            url: form.attr('action'),
            data: form.serialize(),
            success: function(response) {
                if (response.status === 'success') {
                    alert(response.message);
                    var feedbackOffcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('feedbackSidebar'));
                    feedbackOffcanvas.hide();
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                } else {
                    alert(response.message);
                }
            },
            error: function(xhr) {
                alert('An error occurred while submitting feedback. Please try again.');
                console.log(xhr.status + ": " + xhr.responseText);
            }
        });
    });
});
</script>
